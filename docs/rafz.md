# üï∞Ô∏è TimeEngine + RafzCoordinator: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `AdaptiveTimeEngine` –∏ `RafzCoordinator` –≤
–∞–Ω–∏–º–∞—Ü–∏—è—Ö —Å React Spring –∏ MobX. –û–Ω –ø–æ–º–æ–∂–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–π, –æ—à–∏–±–æ–∫ `frameLoop`, –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é
–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. AdaptiveTimeEngine (timeEngine)

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä, —É–ø—Ä–∞–≤–ª—è—é—â–∏–π –ª–æ–≥–∏–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏, FPS, –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏, –∏ –≤—ã–∑–æ–≤–æ–º `raf.advance()` –≤—Ä—É—á–Ω—É—é.

#### –ú–µ—Ç–æ–¥—ã:

* `start()` / `stop()` ‚Äî –∑–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
* `enableVSync()` / `disableVSync()` ‚Äî —Ä–µ–∂–∏–º VSync –∏–ª–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç—ã
* `setTargetFps(fps)` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–µ–≤–æ–≥–æ FPS –ø—Ä–∏ `VSync = false`
* `setTimeScale(scale)` ‚Äî –º–∞—Å—à—Ç–∞–± –≤—Ä–µ–º–µ–Ω–∏ (—É—Å–∫–æ—Ä–µ–Ω–∏–µ/–∑–∞–º–µ–¥–ª–µ–Ω–∏–µ)
* `registerRenderCallback(id, fn)` ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–ª–±—ç–∫–æ–≤ –Ω–∞ –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä
* `unregisterRenderCallback(id)` ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–±—ç–∫–∞

### 2. RafzCoordinator

–£–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–∑–∞–º–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø–æ–¥–º–µ–Ω—è–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ `@react-spring/rafz`. –†–∞–±–æ—Ç–∞–µ—Ç **—Ç–æ–ª—å–∫–æ** –≤ `frameLoop: "demand"`.

#### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:

* –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç `raf.advance()` —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ (–¥–µ–ª–∞–µ—Ç —ç—Ç–æ timeEngine)
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ö—É–∫–∏ —Ñ–∞–∑: `onStart`, `onFrame`, `onFinish`
* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤—Ä–µ–º—è —á–µ—Ä–µ–∑ `raf.now()`
* –ü–æ–¥–º–µ–Ω—è–µ—Ç `requestAnimationFrame` –≥–ª–æ–±–∞–ª—å–Ω–æ

---

## ‚úÖ –ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã

1. **–¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** ‚Äî `timeEngine`
2. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ `frameLoop: "demand"`** –≤–µ–∑–¥–µ, –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `useSpring` –∏–ª–∏ `api.start()`
3. **`rafzCoordinator`** –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç `advance`, —Ç–æ–ª—å–∫–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∞–∑—ã

---

## üì¶ –ü—Ä–∏–º–µ—Ä—ã

### üéØ useSpring —Å —Ä—É—á–Ω—ã–º loop‚Äô–æ–º

```ts
const styles = useSpring({
  from: { opacity: 0 },
  to: { opacity: 1 },
  config: { duration: 1000 },
  frameLoop: "demand"
});
```

### üß† useSpringSync (—Ö—É–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)

```ts
import { useSpringSync } from "@stores/timeEngine";

const [styles, api] = useSpring(() => ({
  from: { scale: 0 },
  to: { scale: 1 },
  frameLoop: "demand"
}));

useSpringSync(api); // –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ –∏–∑ timeEngine
```

### üåÄ useFramerMotionSync

```ts
import { useFramerMotionSync } from "@stores/timeEngine";

const controls = useAnimation();
useFramerMotionSync(controls);
```

### üß© –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ renderCallback

```ts
useEffect(() => {
  const id = "my-debug-fps-logger";
  const dispose = timeEngine.registerRenderCallback(id, (fid, dt, elapsed) => {
    console.log(`[Frame ${fid}] dt=${dt.toFixed(2)}ms, t=${elapsed.toFixed(2)}ms`);
  });

  return () => dispose();
}, []);
```

---

## üõ† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ú–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–∫–ª—é—á–∏—Ç—å:

```ts
console.log("Current FPS:", timeEngine.fps);
```

–ò–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å `frameId`, `deltaTime`, `elapsedTime` –ø—Ä—è–º–æ –≤ `timeEngine._update()` –¥–ª—è –≥–ª—É–±–æ–∫–æ–π –æ—Ç–ª–∞–¥–∫–∏.

---

## ‚ùó –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

| –û—à–∏–±–∫–∞                                             | –ü—Ä–∏—á–∏–Ω–∞                                                | –†–µ—à–µ–Ω–∏–µ                          |
|----------------------------------------------------|--------------------------------------------------------|----------------------------------|
| `Cannot call advance when frameLoop is not demand` | `useSpring` –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è `frameLoop`                   | –î–æ–±–∞–≤—å `frameLoop: "demand"`     |
| –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏                              | `raf.advance()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç          | –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ `timeEngine` |
| –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ—Ä–µ–π–º–æ–≤                          | –∑–∞–±—ã–ª–∏ –≤—ã–∑–≤–∞—Ç—å `useSpringSync` / `useFramerMotionSync` | –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ —Ö—É–∫–∞              |

---

## üéØ –í—ã–≤–æ–¥

üîπ –ò—Å–ø–æ–ª—å–∑—É–π `AdaptiveTimeEngine` –∫–∞–∫ **–µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏**
üîπ –£–±–µ–¥–∏—Å—å, —á—Ç–æ **–≤—Å–µ –∞–Ω–∏–º–∞—Ü–∏–∏** –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ `frameLoop: "demand"`
üîπ –ò—Å–ø–æ–ª—å–∑—É–π `useSpringSync`, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–π –∞–ø–¥–µ–π—Ç
üîπ –ü—É—Å—Ç—å `rafzCoordinator` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä —Ñ–∞–∑, –∞ –Ω–µ —Ç–∞–π–º–µ—Ä

---

–ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω–æ ‚Äî –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Å MobX/React DevTools integration, —Ç–∞–π–º–ª–∞–π–Ω-–ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–æ–º, –∏–ª–∏
—Ö—Ä–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ üöÄ
